pipeline {
    agent any

    environment {
        IMAGE_NAME = "shailendrajr/test_hub:v1"
        CONTAINER_NAME = "aangan-react-container"
        DOCKERHUB_CREDS = credentials("dockerhub-creds")
    }

    stages {

        stage("Checkout Code") {
            steps {
                checkout scm
            }
        }

        stage("Build Docker Image") {
            steps {
                sh '''
                    docker build -t $IMAGE_NAME .
                '''
            }
        }

        stage("Trivy Image Scan") {
            steps {
                sh '''
                    echo "üîç Scanning Docker image using Trivy..."
                    trivy image --exit-code 1 --severity HIGH,CRITICAL $IMAGE_NAME
                '''
            }
        }

        stage("Docker Hub Login") {
            steps {
                sh '''
                    echo "$DOCKERHUB_CREDS_PSW" | docker login -u "$DOCKERHUB_CREDS_USR" --password-stdin
                '''
            }
        }

        stage("Push Image to Docker Hub") {
            steps {
                sh '''
                    docker push $IMAGE_NAME
                '''
            }
        }

        stage("Run Docker Container") {
            steps {
                sh '''
                    docker rm -f $CONTAINER_NAME || true

                    docker run -d \
                      --name $CONTAINER_NAME \
                      -p 3000:80 \
                      $IMAGE_NAME
                '''
            }
        }
    }

    post {
        success {
            echo "‚úÖ Image scanned, pushed to Docker Hub & app running on port 3000"
        }
        failure {
            echo "‚ùå Pipeline failed (Scan / Build / Push error)"
        }
    }
}
